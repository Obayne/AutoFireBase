name: PR Review CI and Request Review

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    ci:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Setup Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"
            - name: Install dev dependencies
              run: |
                  python -m pip install --upgrade pip
                  if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
            - name: Lint (ruff)
              run: |
                  python -m pip install ruff
                  ruff check --fix . || true
            - name: Run tests
              run: |
                  python -m pip install pytest
                  pytest -q

    request-review:
        needs: ci
        runs-on: ubuntu-latest
        steps:
            - name: Request codex as reviewer and add labels
              uses: actions/github-script@v6
              with:
                  script: |
                      const pr = context.payload.pull_request;
                      if (!pr) {
                        console.log('No pull request context');
                      } else {
                        const owner = context.repo.owner;
                        const repo = context.repo.repo;
                        const number = pr.number;
                        // Request the codex user as a reviewer (review-only per repo rules)
                        await github.rest.pulls.requestReviewers({ owner, repo, pull_number: number, reviewers: ['codex'] });
                        // Add a helpful label so humans see this needs review
                        await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: ['needs-review'] });
                        console.log('Requested @codex and applied labels');
                      }
