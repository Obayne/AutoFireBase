name: PR Size Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label-size:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const total = additions + deletions;
            
            // Define size thresholds
            let sizeLabel = '';
            if (total < 10) {
              sizeLabel = 'size: XS';
            } else if (total < 50) {
              sizeLabel = 'size: S';
            } else if (total < 200) {
              sizeLabel = 'size: M';
            } else if (total < 500) {
              sizeLabel = 'size: L';
            } else {
              sizeLabel = 'size: XL';
            }
            
            core.info(`PR has ${additions} additions and ${deletions} deletions (total: ${total})`);
            core.info(`Assigning label: ${sizeLabel}`);
            
            // Ensure the label exists
            const allSizeLabels = ['size: XS', 'size: S', 'size: M', 'size: L', 'size: XL'];
            const colors = {
              'size: XS': '00ff00',
              'size: S': '7cfc00',
              'size: M': 'ffa500',
              'size: L': 'ff6347',
              'size: XL': 'ff0000'
            };
            
            for (const label of allSizeLabels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label,
                });
              } catch (e) {
                core.info(`Creating label: ${label}`);
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label,
                  color: colors[label],
                  description: `PR size: ${label.split(': ')[1]}`,
                });
              }
            }
            
            // Remove old size labels
            const currentLabels = pr.labels.map(l => l.name);
            const oldSizeLabels = currentLabels.filter(l => l.startsWith('size: ') && l !== sizeLabel);
            
            for (const label of oldSizeLabels) {
              core.info(`Removing old size label: ${label}`);
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                name: label,
              }).catch(e => core.warning(`Failed to remove label ${label}: ${e.message}`));
            }
            
            // Add the new size label
            if (!currentLabels.includes(sizeLabel)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: [sizeLabel],
              });
            }
